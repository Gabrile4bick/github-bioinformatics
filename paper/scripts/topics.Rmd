---
title: "Topic modeling of article abstracts"
output: html_document
---

## Envirnoment setup

```{r setup}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
```

## Run topic modeling on article abstracts associated with each repo

```{r run_topic_modeling}
source("~/Dropbox/Documents/Github_mining/src/R/document_classification/topics.R")
```

## Plot top terms

```{r plot_topics, fig.width = 7, fig.height = 8}
# Plot top terms
facet_text <- num_repos_per_topic %>% mutate(label = paste(total, "repos"))
facet_text$facet <- factor(facet_text$topic, levels = num_repos_per_topic$topic)
plt_data <- top_terms %>%
  left_join(num_repos_per_topic, by = "topic") %>%
  mutate(term = reorder(term, beta)) %>%
  rename(Beta = beta, Term = term, Total_repos = total)
plt_data$facet <- factor(plt_data$topic, levels = num_repos_per_topic$topic)
plt_data %>% ggplot(aes(Term, Beta)) +
  geom_col(show.legend = FALSE, fill = "red3") +
  facet_wrap(~ facet, scales = "free_y", nrow = 4) +
  theme_bw() +
  theme(axis.title = element_text(size = 12.5),
        axis.text = element_text(size = 10.5),
        strip.text = element_text(size = 10.5)) +
  coord_flip() + 
  geom_text(data = facet_text,
    mapping = aes(x = -Inf, y = -Inf, label = label),
    hjust = -1.4,
    vjust = -1.4,
    inherit.aes = FALSE,
    size = 5)
rm(facet_text, plt_data)
```


## Amount of code per language and topic

```{r languages}
# Read in repo data and get bytes per language
repo_data <- load_repo_features()
bytes_per_lang <- repo_data %>% select(repo_name, starts_with("bytes"))

# Summarize total bytes per topic. Has bytes double counted if repos have multiple topics.
bytes_per_topic <- abstract_top_topics %>% 
  select(repo_name, topic) %>% 
  left_join(bytes_per_lang, by = "repo_name") %>% 
  group_by(topic) %>% 
  summarise_at(vars(starts_with("bytes")), mean)
colnames(bytes_per_topic) <- gsub("bytes_", "", colnames(bytes_per_topic))
bytes_per_topic <- bytes_per_topic %>% 
  melt(id.vars = "topic") %>%
  rename(Topic = topic, Language = variable, Bytes = value)

# Bubble plot of amount of code per language vs topic
require(scales)
ggplot(bytes_per_topic, aes(Topic, Language)) + 
  geom_point(aes(size = Bytes)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_size(labels = comma)
```


## Topics vs journals

```{r journals}
articles_per_journal <- article_data %>% 
  filter(!is.na(iso_abbrev)) %>%
  group_by(iso_abbrev) %>% 
  summarise(num_articles = n()) %>% 
  arrange(-num_articles)

top_journals <- articles_per_journal[1:10, "iso_abbrev"][[1]]

topics_by_journal <- abstract_top_topics %>% 
  select(repo_name, topic) %>% 
  left_join(article_data %>% select(repo_name, iso_abbrev), by = "repo_name") %>% 
  rename(journal = iso_abbrev) %>%
  filter(journal %in% top_journals) %>%
  group_by(topic, journal) %>%
  summarise(num_repos = n())

# Bubble plot of topics vs journals
ggplot(topics_by_journal, aes(topic, journal)) + 
  geom_point(aes(size = num_repos)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
