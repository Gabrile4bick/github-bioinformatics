---
title: "Repo-level associations"
author: "Pamela Russell"
date: "12/19/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r env_setup}
rm(list=ls())
suppressPackageStartupMessages(library(bigrquery))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
setwd("~/Documents/Github_mining/src/R/exploratory_analysis")
source("project_info.R")
```

```{r util}
# Helpful functions / utilities

# Get formatted table ID e.g. "[github-bioinformatics-171721:analysis.lines_of_code_by_file]"
table_str <- function(dataset, table) {paste("[", proj, ":", dataset, ".", table, "]", sep="")}

# Get query result from BigQuery
fetch_query_res <- function(query) {query_exec(query, project = proj, max_pages = Inf)}

# Join a table to repo_data
join_tbl <- function(data) {
  repo_data <<- full_join(repo_data, data, by = "repo_name")
}

# Change NA to 0
na_to_zero <- function(x) {
  if(is.na(x)) 0
  else x
}
```

```{r init_df}
# Initialize table for all repo-level data
repo_data <- data.frame(repo_name = character(0))
```

```{r lines_of_code_by_repo}
# Add data from lines of code by repo table
join_tbl(
  list_tabledata(project = proj, dataset = ds_analysis, table = table_loc_by_repo) %>%
    rename(total_lines_of_code = lines_of_code))
```

```{r commit_types}
# Add data from commit types table
commit_types <- list_tabledata(project = proj, dataset = ds_analysis, table = table_commit_types) 
commit_types <- commit_types %>%
  mutate(num_bug_fix_commits = sapply(commit_types$num_bug_fix_commits, na_to_zero)) %>%
  mutate(pct_bug_fix_commits = num_bug_fix_commits / num_commits)
join_tbl(commit_types)
rm(commit_types)
```

```{r licenses}
join_tbl(
  list_tabledata(project = proj, dataset = ds_gh, table = table_licenses) %>%
    select(repo_name, license)
)
```

```{r proj_duration}
join_tbl(
  list_tabledata(project = proj, dataset = ds_analysis, table = table_proj_duration)
)
```


```{r num_langs}
join_tbl(
  list_tabledata(project = proj, dataset = ds_analysis, table = table_num_langs_by_repo)
)
```

```{r num_devs}
join_tbl(
  list_tabledata(project = proj, dataset = ds_analysis, table = table_num_devs_by_repo)
)
```

```{r repo_metrics}
join_tbl(
  list_tabledata(project = proj, dataset = ds_gh, table = table_repo_metrics) %>%
    select(repo_name, is_fork, stargazers_count, watchers_count, forks_count, subscribers_count)
)
```

```{r repo_and_article}
query <- paste("SELECT repo_name, journal, year, use_repo FROM [", 
               proj, ":", ds_lit_search, ".", table_repo_and_article, "]", 
               sep="")
join_tbl(
  query_exec(query, project = proj) %>%
    filter(use_repo == T) %>%
    select(repo_name, journal, year_published = year)
)
```

```{r file_info}
query <- paste("SELECT repo_name, size FROM [", 
               proj, ":", ds_gh, ".", table_file_info, "]", 
               sep="")
file_sizes <- query_exec(query, project = proj, max_pages = Inf)

join_tbl(
  file_sizes %>% 
    group_by(repo_name) %>% 
    summarize(
      total_files = n(), 
      total_file_size = sum(as.numeric(size)), 
      largest_file_size = max(as.numeric(size)), 
      mean_file_size = mean(as.numeric(size)))
)

rm(file_sizes)
```

```{r code_chunk_freq}
# Function to process one version of code chunk frequency table
process_code_chunk_freq <- function(table_name, col_suffix) {
  
  query <- paste("SELECT repo_name, num_occurrences FROM [", 
                 proj, ":", ds_analysis, ".", table_name, "]", 
                 sep = "")
  
  code_chunk_freq <- query_exec(query, project = proj, max_pages = Inf)
  
  total_code_chunks <- code_chunk_freq %>% 
    group_by(repo_name) %>% 
    summarize(total_code_chunks = n())
  
  repeated_code_chunks <- code_chunk_freq %>% 
    filter(num_occurrences > 1) %>%
    group_by(repo_name) %>% 
    summarize(repeated_code_chunks = n())
  
  max_code_chunk_occurrence <- code_chunk_freq %>%
    group_by(repo_name) %>%
    summarise(max_code_chunk_occurrence = max(num_occurrences))
  
  mean_code_chunk_occurrence <- code_chunk_freq %>%
    group_by(repo_name) %>%
    summarise(mean_code_chunk_occurrence = mean(num_occurrences))
  
  join_data <- total_code_chunks %>%
    full_join(repeated_code_chunks, by = "repo_name") %>%
    full_join(max_code_chunk_occurrence, by = "repo_name") %>%
    full_join(mean_code_chunk_occurrence, by = "repo_name")
  
  colnames(join_data) <- sapply(colnames(join_data), function(x) {
    if(x == "repo_name") x
    else paste(x, "_", col_suffix, sep="")
  })
  
  # Join tables
  join_tbl(join_data)

}

# Do the work
process_code_chunk_freq(table_code_chunk_freq_10_50, "10_50")
process_code_chunk_freq(table_code_chunk_freq_5_80, "5_80")

```



