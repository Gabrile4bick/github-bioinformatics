---
title: "Repo-level associations"
author: "Pamela Russell"
date: "12/19/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r env_setup}
rm(list=ls())
suppressPackageStartupMessages(library(bigrquery))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(parsedate))
source("~/Dropbox/Documents/Github_mining/src/R/project_info.R")
```

```{r load_data_table}
repo_data <- load_repo_features()
```

```{r associations}
k <- ncol(repo_data)
n_comparisons <- k * (k - 1)
pval_cutoff <- 0.0001 / n_comparisons

assoc.numeric <- data.frame(var1 = character(), var2 = character(), corr = numeric(), pval = numeric())
assoc.mannwhitney <- data.frame(var1 = character(), var2 = character(), pval = numeric())
assoc.sets <- data.frame(var1 = character(), var2 = character(), similarity = numeric())

add_mw <- function(data_numeric, data_logical, name_numeric, name_logical) {
  x <- tryCatch({
    data_yes <- data_numeric[which(data_logical)]
    data_no <- data_numeric[which(!data_logical)]
    res <- wilcox.test(data_yes, data_no, alternative = "two.sided", paired = F)
    if(res$p.value < pval_cutoff) {
      record <- data.frame(var1 = name_numeric, var2 = name_logical, pval = res$p.value)
      assoc.mannwhitney <<- rbind(assoc.mannwhitney, record)
    }
  }, error = function(e) {
    message(paste("CAUGHT ERROR on", name_numeric, "and", name_logical))
  })
}

for (i in 1:k) {
  data1 <- repo_data[[i]]
  name1 <- names(repo_data)[i]
  if(!is.numeric(data1) && !is.logical(data1)) {
    message(paste("Skipping", name1))
  }
  for (j in 1:k) {
    data2 <- repo_data[[j]]
    name2 <- names(repo_data)[j]
    
    # Only compare each pair of columns once
    if (i < j) {
      
      if (is.numeric(data1) && is.numeric(data2)) {
        # Both numeric
        x <- tryCatch({
          res <- cor.test(data1, data2)
          if (res$estimate > 0.5 && res$p.value < pval_cutoff) {
            record <- data.frame(var1 = name1, var2 = name2, corr = res$estimate, pval = res$p.value)
            assoc.numeric <- rbind(assoc.numeric, record)
          }
        }, error = function(e) {
          message(paste("CAUGHT ERROR on", name1, "and", name2))
        })
      } else if (is.numeric(data1) && is.logical(data2)) {
        # data1 numeric, data2 logical
        add_mw(data1, data2, name1, name2)
      } else if (is.logical(data1) && is.numeric(data2)) {
        # data1 logical, data2 numeric
        add_mw(data2, data1, name2, name1)
      } else if (is.logical(data1) && is.logical(data2)) {
        # both logical
        repos1 <- repo_data[which(data1), "repo_name"]
        repos2 <- repo_data[which(data2), "repo_name"]
        jaccard <- length(intersect(repos1, repos2)) / length(union(repos1, repos2))
        record <- data.frame(var1 = name1, var2 = name2, similarity = jaccard)
        assoc.sets <- rbind(assoc.sets, record)
      }
    }
  }
}
rm(data1, data2, i, j, k, n_comparisons, name1, name2, res, x, record,
   pval_cutoff, jaccard, repos1, repos2)
```

```{r save_data}
# Save repo_data to a file
repo_data_cached <- repo_data
save(repo_data_cached, file = repo_data_file)
```

