---
title: 'Exploratory analysis: code quality'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```


```{r echo = F}
rm(list=ls())
suppressPackageStartupMessages(library(bigrquery))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
setwd("~/Documents/Github_mining/src/R/exploratory_analysis")
```


```{r}
# Project info
proj <- "github-bioinformatics-157418"
ds_gh <- "test_repos"
ds_analysis <- "test_repos_analysis_results"
ds_lang <- "languages"
table_loc_by_repo <- "lines_of_code_by_repo"
table_code_chunk_freq_10_50 <- "code_chunk_freq_by_repo_10_50"
table_code_chunk_freq_5_80 <- "code_chunk_freq_by_repo_5_80"
```


```{r fig.height = 7, fig.width = 7}
# Load the data from BigQuery
lines_of_code_by_repo <- list_tabledata(project = proj, dataset = ds_analysis, table = table_loc_by_repo)
query_10_50 <- paste("SELECT * FROM [", proj, ":", ds_analysis, ".", table_code_chunk_freq_10_50, "] WHERE num_occurrences > 1", sep="")
dup_chunks_10_50 <- query_exec(query_10_50, project = proj)
total_loc_in_dup_chunks_10_50 <- 
  dup_chunks_10_50 %>% 
  group_by(repo_name) %>% 
  summarize(sum_dup_chunk_len = 10 * sum(num_occurrences)) %>%
  right_join(lines_of_code_by_repo, by = "repo_name")
total_loc_in_dup_chunks_10_50[is.na(total_loc_in_dup_chunks_10_50)] <- 0

# Make plot
axmax <- log10(max(total_loc_in_dup_chunks_10_50$lines_of_code)) + 0.1
ggplot(total_loc_in_dup_chunks_10_50, aes(x = log10(lines_of_code), y = log10(sum_dup_chunk_len))) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  xlim(0, axmax) +
  ylim(0, axmax) +
  labs(title = "Lines of code in duplicate chunks (10 lines; length >= 50)",
       x = "Total lines of code in repo (log10)",
       y = "Total lines of code in duplicated chunks (lines can be double counted)")
```




